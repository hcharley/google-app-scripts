<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

    <script>
      function onSuccess(contents) {
        var div = document.getElementById('output');
        div.innerHTML = contents;
        handleMeta();
      }
      
      function displayFormMessage(text) {
        // first, switch the "published" text to say "No"
        // because the headline and/or byline has likely changed.
        setPublishedFlag(false);
        var div = document.getElementById('form-output');
        div.innerHTML = text;
      }

      function setPublishedFlag(value) {
        var isPublishedSpan = document.getElementById('is-published');
        var isPublishedYesNo = "no";
        if (value) {
          isPublishedYesNo = "yes";
        }
        isPublishedSpan.innerHTML = isPublishedYesNo;
      }

      function onSuccessMeta(data) {
        var revisionIdSpan = document.getElementById('revision-id');
        revisionIdSpan.innerHTML = data.articleID;

        setPublishedFlag(data.isPublished);

        var articleHeadline = document.getElementById('article-headline');
        articleHeadline.value = data.headline;

        var articleByline = document.getElementById('article-byline');
        articleByline.value = data.byline;
      }

      function handleMeta() {
         google.script.run.withSuccessHandler(onSuccessMeta).getArticleMeta();
      }

      function handleClick() {
         google.script.run.withSuccessHandler(onSuccess).getCurrentDocContents();
      }
      
      window.onload = (function(){
        handleMeta();
      });

      function handleFormSubmit(formObject) {
        google.script.run.withSuccessHandler(displayFormMessage).processForm(formObject);
      }

      // Prevent forms from submitting.
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', preventFormSubmit);
    </script>
    <style>
      .branding-below {
        bottom: 56px;
        top: 0;
      }
      </style>

  </head>
  <body>
    <div class="sidebar branding-below">
      <h1 class="title">Publishing Info</h1>

      <form id="articleMeta" onsubmit="handleFormSubmit(this)">
        <div id="form-output" class="block secondary"></div>
        <div class="block form-group">
          <label for="article-headline">
            <b>Headline</b>
          </label>
          <input id="article-headline" name="article-headline" type="text" />
        </div>
        <div class="block form-group">
          <label for="article-byline">
            <b>Byline</b>
          </label>
          <input id="article-byline" name="article-byline" type="text" />
        </div>
        <div class="block">
          <button class="blue">Submit</button>
        </div>
      </form>

      <div class="block">
        <p>
          <b>Revision ID:</b> <span id="revision-id"></span>
        </p>
        <p>
          <b>Published?</b> <span id="is-published"></span>
        </p>
      </div>

      <div id="output" class="block"></div>
      
      <div class="block">
        <button class="button blue" onclick="handleClick()">Save Article</button>
      </div>
    </div>
    <div class="sidebar bottom">
      <span class="gray">
        Powered by News Catalyst
      </span>
    </div>

  </body>
</html>


