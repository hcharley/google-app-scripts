<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

    <script>
      // thanks stack overflow 
      // https://stackoverflow.com/questions/8888491/how-do-you-display-javascript-datetime-in-12-hour-am-pm-format
      function formatDate(dateString) {
        var d = new Date(dateString);
        return d.toLocaleString();
      }

      // javascript date handling is awful
      // function from https://stackoverflow.com/a/17415677
      function toIsoString(date) {
        var tzo = -date.getTimezoneOffset(),
            dif = tzo >= 0 ? '+' : '-',
            pad = function(num) {
                var norm = Math.floor(Math.abs(num));
                return (norm < 10 ? '0' : '') + norm;
            };

        return date.getFullYear() +
            '-' + pad(date.getMonth() + 1) +
            '-' + pad(date.getDate()) +
            'T' + pad(date.getHours()) +
            ':' + pad(date.getMinutes()) +
            ':' + pad(date.getSeconds()) +
            dif + pad(tzo / 60) +
            ':' + pad(tzo % 60);
      }

      function setValueOrDefault(elementId, value, defaultValue) {
        var element = document.getElementById(elementId);
        if (value !== undefined && value !== null && value !== "") {
          element.value = value;
        } else {
          element.value = defaultValue;
        }
      }

      function displayCategories(categories, selectedCategory) {
        var articleCategorySelect = document.getElementById('article-category');
        var categoriesSorted = categories.sort(function (a, b) {
          let comparison = 0;
          let aTitle, bTitle;
          if (a.category_translations && a.category_translations[0] && a.category_translations[0].title) {
            aTitle = a.category_translations[0].title
          }
          if (b.category_translations && b.category_translations[0] && b.category_translations[0].title) {
            bTitle = b.category_translations[0].title
          }
          if (aTitle > bTitle) {
            comparison = 1;
          } else if (aTitle < bTitle) {
            comparison = -1;
          }
          return comparison;
        });
        categoriesSorted.forEach(category => {
          // first check if this option already exists; don't add dupes!
          var selectorString = "#article-category option[value='" + category.id + "']";
          if ( $(selectorString).length <= 0 ) {
            var option = document.createElement("option");
            if (category.category_translations && category.category_translations[0] && category.category_translations[0].title) {
              var optionText = category.category_translations[0].title;
              if (!category.published) {
                optionText += " (hidden)";
              }
              option.text = optionText;
            } else {
              option.text = "(BUG) unknown title";
            }
            option.value = category.id;

            if (selectedCategory && selectedCategory.id !== null && selectedCategory.id == category.id) {
              option.selected = true;
            }
            articleCategorySelect.add(option);
          }
        })
      }

      function displayTags(tags, articleTags) {
        var articleTagsSelect = document.getElementById('article-tags');

        // first clear out previous tags - without doing this, we end up with dupes of all the tags
        // after previewing or publishing
        var length = articleTagsSelect.options.length;
        for (i = length-1; i >= 0; i--) {
          articleTagsSelect.options[i] = null;
        }

        tags.forEach(tag => {
          // first check if this option already exists; don't add dupes!
          var selectorString = "#article-tags option[value='" + tag.slug + "']";
          if ( $(selectorString).length <= 0 ) {
            var option = document.createElement("option");
            if (tag.tag_translations && tag.tag_translations[0] && tag.tag_translations[0].title) {
              option.text = tag.tag_translations[0].title;
            } else {
              option.text = "(BUG) unknown title";
            }
            option.value = tag.slug;

            if (articleTags) {
              const result = articleTags.find( ({ tag_id }) => tag_id === tag.id );
              if (result !== undefined) {
                option.selected = true;
              }
            }
            articleTagsSelect.add(option);
          }
        })
      }

      function displayLocales(locales, currentLocale) {
        var articleLocaleSelect = document.getElementById('article-locale');
        if (locales) {
          locales.forEach(localeData => {
            // first check if this option already exists; don't add dupes!
            var selectorString = "#article-locale option[value='" + localeData.locale.code + "']";
            if ( $(selectorString).length <= 0 ) {
              var option = document.createElement("option");
              if (localeData.locale.code) {
                option.text = localeData.locale.code;
              } else {
                option.text = "(BUG) unknown locale";
              }
              // mark this locale as selected if it's the article's locale ID -or- is the default locale
              if (currentLocale === localeData.locale.code) {
                option.selected = true;
              }
              option.value = localeData.locale.code;
              articleLocaleSelect.add(option);
            }
          })

        } else {
          var option = document.createElement("option");
          option.text = currentLocale;
          option.selected = true;
          option.value = currentLocale;
          articleLocaleSelect.add(option);
        }
      }

      function displayAuthors(authors, articleAuthors) {
        var articleAuthorSelect = document.getElementById('article-authors');
        authors.forEach(author => {
          // first check if this option already exists; don't add dupes!
          var selectorString = "#article-authors option[value='" + author.id + "']";
          if ( $(selectorString).length <= 0 ) {
            var option = document.createElement("option");
            if (author && author.last_name) {
              // I found this awesome way of joining non-empty strings here https://stackoverflow.com/a/19903063
              option.text = [author.first_names, author.last_name].filter(Boolean).join(" ");
            } else {
              option.text = "(BUG) unknown name";
            }
            option.value = author.id;

            var authorJoinData;
            if (articleAuthors) {
              authorJoinData = articleAuthors;
            }
            if (authorJoinData !== undefined) {
              var foundAuthor = authorJoinData.find( (aa) => aa.author.id === author.id);
              if (foundAuthor) {
                option.selected = true;
              }
            }
          }
          articleAuthorSelect.add(option);
        })
      }

      function displayPublishedInfo(publishedInfo, translationData) {
          var pubInfoDiv = document.getElementById("published-info");
          var firstSpan = document.getElementById("first-published-at");
          firstSpan.innerHTML = formatDate(publishedInfo.first_published_at);
          var lastSpan = document.getElementById("last-published-at");
          lastSpan.innerHTML = formatDate(publishedInfo.last_published_at);

          var translationIdSpan = document.getElementById("translation-id");
          if (translationData && publishedInfo.id === translationData.id) {
            translationIdSpan.innerHTML = "This translation was published at:";
          } else {
            translationIdSpan.innerHTML = "Another translation with id " + publishedInfo.id + " was published at:";
          }
          pubInfoDiv.style.display = "block";
      }

      function setPublishedFlag(value) {
        // var isPublishedSpan = document.getElementById('is-published');
        var isPublishedYesNo = "no";

        if (value === "true" || value === true) { // ðŸ˜­ javascript + JSON + boolean `published: true` or `published: false` as string
          isPublishedYesNo = "yes";

          var publishButtonTop = document.getElementById('publish-button-top');
          publishButtonTop.value = "Re-publish";
          var publishButtonBottom = document.getElementById('publish-button-bottom');
          publishButtonBottom.value = "Re-publish";

          // display the unpublish button
          var unpublishButtonTop = document.getElementById('unpublish-button-top');
          unpublishButtonTop.style.display = "inline";
          var unpublishButtonBottom = document.getElementById('unpublish-button-bottom');
          unpublishButtonBottom.style.display = "inline";

        } else {
          var publishButtonTop = document.getElementById('publish-button-top');
          publishButtonTop.value = "Publish";
          var publishButtonBottom = document.getElementById('publish-button-bottom');
          publishButtonBottom.value = "Publish";

          // hide the unpublish button
          var unpublishButtonTop = document.getElementById('unpublish-button-top');
          unpublishButtonTop.style.display = "none";
          var unpublishButtonBottom = document.getElementById('unpublish-button-bottom');
          unpublishButtonBottom.style.display = "none";

          var pubInfoDiv = document.getElementById("published-info");
          var translationIdSpan = document.getElementById("translation-id");
          translationIdSpan.innerHTML = "";
          pubInfoDiv.style.display = "none";
        }
        // isPublishedSpan.innerHTML = isPublishedYesNo;
      }

      function onSuccessCreateDoc(contents) {
        console.log("onSuccessCreateDoc: ", contents);

        var buttonId = 'translate-button-top-' + contents.locale;
        var button = document.getElementById(buttonId);
        button.innerHTML = "Open Translation";

        button.setAttribute("class", "blue");
        button.setAttribute("type", "button");

        var buttonOpenLink = "window.open('" + contents.url + "', '_blank')";
        button.setAttribute("onClick", buttonOpenLink);
        // button.innerHTML = "Open " + doc.locale_code;
        button.href = contents.url;

        window.open(contents.url, '_blank');
      }

      function handleCreateDoc(el) {
        var localeCode = $(el).data('locale'); 
        var docType = $(el).data('doc-type');
        var headline = $(el).data('headline');
        var id;
        if (docType === "page") {
          id = $(el).data('page-id');
          google.script.run.withFailureHandler(onFailure).withSuccessHandler(onSuccessCreateDoc).hasuraCreatePageDoc(id, localeCode, headline);
        } else {
          id = $(el).data('article-id');
          google.script.run.withFailureHandler(onFailure).withSuccessHandler(onSuccessCreateDoc).hasuraCreateArticleDoc(id, localeCode, headline);
        }
      }

      function onSuccessGetArticle(contents) {

        var configDiv = document.getElementById('config');
        configDiv.style.display = 'none';
        var div = document.getElementById('loading');
        div.style.display = 'block';
        var form = document.getElementById('article-form');
        form.style.display = "block";

        var buttonsDivBottom = document.getElementById('action-buttons-bottom')
        buttonsDivBottom.style.display = "block";
        var buttonsDivTop = document.getElementById('action-buttons-top')
        buttonsDivTop.style.display = "block";

        if (contents && contents.status && contents.status === "error") {
          div.innerHTML = "<p class='error'>An error occurred: " + contents.message + '</p>';
        } else {
          div.innerHTML = '<p style="color: #48C774;">' + contents.message + "</p>";
        }

        console.log("contents onSuccessGetArticle:", contents);
        var typeHiddenField = document.getElementById('document-type');
        var documentType = typeHiddenField.value;

        // hide form fields that are relevant for articles only from documents that are static pages
        if (documentType !== "article") {
          [].forEach.call(document.querySelectorAll('.articles-only'), function (el) {
            el.style.display = 'none';
          });
        }

        var data;
        var googleDocs;
        var translationData;
        var publishedInfo;
        var headline;
        var localeCode = contents.localeCode;
        if (contents.data.articles) {
          if (contents.data.articles[0]) {
            data = contents.data.articles[0]
          }
          if (contents.data.article_translations) {
              translationData = contents.data.article_translations[0];
          }
          if (contents.data.article_google_documents) {
            googleDocs = contents.data.article_google_documents;
          }
          if (contents.data.published_article_translations && contents.data.published_article_translations[0]) {
            publishedInfo = contents.data.published_article_translations[0].article_translation;
            console.log("found publishedInfo:", publishedInfo);
          }
        } else if (contents.data.pages) {
          documentType = "page"
          if (contents.data.pages[0]) {
            data = contents.data.pages[0]
            
          }
          if (contents.data.page_translations) {
            translationData = contents.data.page_translations[0];
          }

          if (contents.data.page_google_documents) {
            googleDocs = contents.data.page_google_documents;
          }
        }

        if (translationData) {
          headline = translationData.headline;
        } else if (contents.data.documentTitle) {
          headline = contents.data.documentTitle;
        } else {
          headline = "tk";
        }
        displayTranslationTools(data.id, contents.documentId, documentType, headline, googleDocs, contents.data.organization_locales);
        
        if (publishedInfo) {
          displayPublishedInfo(publishedInfo, translationData);
        }

        // if (contents.data.organization_locales) {
          displayLocales(contents.data.organization_locales, localeCode);
        // }
        
        if (documentType === "article") {
          displayCategories(contents.data.categories, data.category);
          displayTags(contents.data.tags, data.tag_articles);
          displayAuthors(contents.data.authors, data.author_articles);
        }

        if (data) {
          var slugField = document.getElementById('article-slug');
          slugField.value = data.slug;

          var idHiddenField = document.getElementById('article-id');
          idHiddenField.value = data.id;
          
        }

        // var selectedLocale = document.getElementById('selected-locale');
        if (translationData) {
          setPublishedFlag(translationData.published);

          var articleHeadline = document.getElementById('article-headline');
          articleHeadline.value = translationData.headline;

          // selectedLocale.innerHTML = translationData.locale_code;

          setValueOrDefault('article-custom-byline', translationData.custom_byline, "");
          setValueOrDefault('article-search-title', translationData.search_title, translationData.search_title);
          setValueOrDefault('article-search-description', translationData.search_description, translationData.search_description);
          setValueOrDefault('article-facebook-title', translationData.facebook_title, translationData.facebook_title);
          setValueOrDefault('article-facebook-description', translationData.facebook_description, translationData.facebook_description);
          setValueOrDefault('article-twitter-title', translationData.twitter_title, translationData.twitter_title);
          setValueOrDefault('article-twitter-description', translationData.twitter_description, translationData.twitter_description);
        }

        $('#article-authors').select2({
          width: 'resolve',
        });

        $('#article-tags').select2({
          width: 'resolve',
          tags: true,
          createTag: function (params) {
            var term = $.trim(params.term);

            if (term === '') {
              return null;
            }

            return {
              id: term,
              text: term,
              newTag: true // add additional parameters
            }
          }
        });

        if (documentType === "article") {
          if (publishedInfo) {
            var firstPubDate = new Date(publishedInfo.first_published_at);
            console.log("setting published date to ", firstPubDate, publishedInfo.first_published_at);

            flatpickr('input[name="article-first-published-date"]', {
              enableTime: true,
              dateFormat: "Y-m-d h:i K",
              defaultDate: firstPubDate
            });
          } else {
            var today = new Date();
            flatpickr('input[name="article-first-published-date"]', {
              enableTime: true,
              dateFormat: "Y-m-d h:i K",
              defaultDate: today
            });
          }
        }

        if (data && documentType === "article") {
          google.script.run.withFailureHandler(onFailureFeatured).withSuccessHandler(onSuccessFeatured).isArticleFeatured(data.id);
        }
      }
      
      function onSuccessFeatured(result) {
        if (result && result.featured) {
          
          var div = document.getElementById('featured');
          div.style.display = "block";
          var message = "<b>This article is featured on the homepage</b>";
          if (result.editorUrl) {
            message += ": <a target='_new' href='" + result.editorUrl + "'>edit</a>"
          }
          div.innerHTML = message;

          // hide the unpublish button
          var unpublishButtonTop = document.getElementById('unpublish-button-top');
          unpublishButtonTop.style.display = "none";
          var unpublishButtonBottom = document.getElementById('unpublish-button-bottom');
          unpublishButtonBottom.style.display = "none";
        }
      }

      function onFailureFeatured(error) {
        console.log("onFailureFeatured error:", error);
      }

      function onFailure(error) {
        console.log("onFailure error:", error);
        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "block";
        loadingDiv.innerHTML = "<p class='error'>An error occurred: " + error + "</p>";
        var form = document.getElementById('article-form');
        form.style.display = "none";
      }

      function createTextInputDiv(id, label, name, value) {
        var fieldName;
        if (id === null) {
          fieldName = "source[]." + name;
        } else {
          fieldName = "source[" + id + "]." + name;
        }

        var div = document.createElement("div");
        div.class = "block form-group"
        var labelTag = document.createElement("label");
        labelTag.setAttribute("for", fieldName);
        labelTag.innerHTML = "<b>" + label + ":</b>";
        div.appendChild(labelTag);
        var input = document.createElement("input");
        input.type = "text";
        input.name = fieldName;
        input.value = value;
        div.appendChild(input);
        return div
      }

      function createSelectDiv(id, label, name, value, choices) {
        var fieldName;
        if (id === null) {
          fieldName = "source[]." + name;
        } else {
          fieldName = "source[" + id + "]." + name;
        }

        var div = document.createElement("div");
        div.class = "block form-group"

        var labelTag = document.createElement("label");
        labelTag.setAttribute("for", fieldName);
        labelTag.innerHTML = "<b>" + label + ":</b>";
        div.appendChild(labelTag);

        var select = document.createElement("select");
        select.style = "width: 100%";
        select.name = fieldName;

        var pleaseChooseOption = document.createElement("option");
        pleaseChooseOption.setAttribute("disabled", "");
        pleaseChooseOption.setAttribute("selected", "");
        pleaseChooseOption.value = "";
        select.appendChild(pleaseChooseOption);

        choices.forEach(choice => {
          var option = document.createElement("option");
          option.value = choice;
          option.innerHTML = choice;
          if (value === choice) {
            option.selected = "selected";
          }
          select.appendChild(option);
        })
        div.appendChild(select);

        return div;
      }

      function selectOption(fieldName, fieldValue) {
        var field = document.getElementById(fieldName);
        var opts = field.options;
        for (var opt, i = 0; opt = opts[i]; i++) {
          if (opt.value == fieldValue) {
            field.selectedIndex = i;
            break;
          }
        }
      }

      function expandSource(sourceId) {
        
        var sourceContainer = document.getElementById('sources-container');
        // first hide all source forms
        var i;
        for (i = 0; i < sourceContainer.children.length; i++) {
        // sourceContainer.children.forEach(el => {
          var el = sourceContainer.children[i];
          if (/source-form-/.test(el.id)) {
            el.style.display = "none";
          }
        }
        var sourceFormDiv = document.getElementById("source-form-" + sourceId);
        sourceFormDiv.style.display = "block";
      }

      function addAnotherSourceForm() {
        // determine how many new field sets there are
        // call addAnotherSource with the right id

        var blankSource = {
          name: "",
          race: "",
          zip: "",
          affiliation: "",
          phone: "",
          email: "",
          gender: "",
          sexual_orientation: "",
          ethnicity: "",
          role: "",
          age: ""
        }

        var counterField = document.getElementById("source-tracking-counter");
        // console.log("counter is currently: ", counterField.value, parseInt(counterField.value));
        var newCount = parseInt(counterField.value) + 1;
        counterField.value = newCount;
        var newId = "new_" + newCount;
        // console.log("adding new source with id", newId)
        addAnotherSource(newId, blankSource, true);

      }

      function addAnotherSource(id, data, showForm) {
        var sourceContainer = document.getElementById('sources-container');

        var formDiv = document.createElement("div");
        if (!showForm) {
          formDiv.style.display = "none";
        }
        formDiv.id = "source-form-" + id;

        var nameDiv = createTextInputDiv(id, "Name", "name", data.name);
        formDiv.appendChild(nameDiv);

        var affDiv = createTextInputDiv(id, "Affiliation", "affiliation", data.affiliation)
        formDiv.appendChild(affDiv);

        var races = [
          "White",
          "Black or African-American",
          "American Indian or Alaskan Native",
          "Asian",
          "Native Hawaiian or other Pacific Islander",
          "From multiple races",
          "Prefer to self-describe",
          "Other"
        ];
        var raceDiv = createSelectDiv(id, "Race", "race", data.race, races);
        formDiv.appendChild(raceDiv);

        var ethnicities = [
          "African, African-American",
          "Asian, Asian-American",
          "European, European-American (Caucasian)",
          "Latino, Latino-American, Chicano",
          "Native American or Alaska Native",
          "Middle Eastern",
          "Multiethnic",
          "Prefer to self-describe",
          "Other"
        ];

        var ethnicityDiv = createSelectDiv(id, "Ethnicity", "ethnicity", data.ethnicity, ethnicities);
        formDiv.appendChild(ethnicityDiv);

        var genders = [
          "Female",
          "Male",
          "Non-binary/third gender",
          "Transgender",
          "Agender",
          "Genderqueer",
          "Prefer to self-describe",
          "Other"
        ];

        var genderDiv = createSelectDiv(id, "Gender", "gender", data.gender, genders);
        formDiv.appendChild(genderDiv);

        var sexOrientations = [
          "Straight/Heterosexual",
          "Gay or Lesbian",
          "Bisexual",
          "Queer",
          "Asexual",
          "Prefer to self-describe",
          "Other"
        ];

        var sexOrientationDiv = createSelectDiv(id, 'Sexual Orientation', "sexual_orientation", data.sexual_orientation, sexOrientations);
        formDiv.appendChild(sexOrientationDiv);

        var ages = [
          "17 or younger",
          "18-20",
          "21-29",
          "30-39",
          "40-49",
          "50-59",
          "60 or older"
        ];

        var ageDiv = createSelectDiv(id, "Age", "age", data.age, ages);
        formDiv.appendChild(ageDiv);

        var zipDiv = createTextInputDiv(id, "Zip Code", "zip", data.zip);
        formDiv.appendChild(zipDiv);

        var emailDiv = createTextInputDiv(id, "Contact Email Address", "email", data.email);
        formDiv.appendChild(emailDiv);

        var phoneDiv = createTextInputDiv(id, "Contact Phone Number", "phone", data.phone);
        formDiv.appendChild(phoneDiv);

        var roles = [
          "Quoted",
          "Mentioned",
          "Background"
        ];

        var roleDiv = createSelectDiv(id, "Role", "role", data.role, roles);
        formDiv.appendChild(roleDiv);

        var dividerLine = document.createElement("hr");
        dividerLine.setAttribute("width", "100%");
        formDiv.appendChild(dividerLine);

        sourceContainer.appendChild(formDiv);

      }

      function handleGetTranslationsForArticle(data) {
        if (data && data.status === "error") {
          onFailure(data.message);
          return;
        }
        var articleId;
        var pageId;
        var localeCode;
        var typeHiddenField = document.getElementById('document-type');
        var documentType = "article";
        
        if (data && data.data && data.data.articles) {
          documentType = "article";
        }
        if (data && data.data && data.data.pages) {
          documentType = "page";
        }

        typeHiddenField.value = documentType;

        if (documentType === "article" && data && data.data && data.data.articles && data.data.articles[0]) {

          articleId = data.data.articles[0].id;
          if (
            data.data.articles[0] && 
            data.data.articles[0].article_google_documents && 
            data.data.articles[0].article_google_documents[0] && 
            data.data.articles[0].article_google_documents[0].google_document) {
              localeCode = data.data.articles[0].article_google_documents[0].google_document.locale_code;
            }

            var blankSource = {
              name: "",
              race: "",
              zip: "",
              affiliation: "",
              phone: "",
              email: "",
              gender: "",
              sexual_orientation: "",
              ethnicity: "",
              role: "",
              age: ""
            }

            var sourceContainer = document.getElementById('sources-container');
            var sourcesCounter = 0;
            sourcesCounter += 1;

            // first add an empty set of form fields to the top of the sources-container
            addAnotherSource("new_1", blankSource);
            sourcesCounter += 1;

            var sourceListContainer = document.getElementById('sources-list-container');
            var sourceUnorderedList = document.createElement("ul");

            // then loop over existing sources and render the filled-in set of form fields
            if (
              data.data.articles[0] &&
              data.data.articles[0].article_sources
              ) {
                var sources = data.data.articles[0].article_sources;
                // console.log("found " + sources.length + " sources");
                sources.forEach(sourceData => {
                  sourcesCounter += 1;
                  var source = sourceData.source;
                  // console.log("found source id# " + source.id);

                  addAnotherSource(source.id, source);

                  var sourceListItem = document.createElement("li");
                  sourceListItem.style.cursor = "pointer";
                  sourceListItem.innerHTML = "<a onClick='expandSource(" + source.id + ")'>" + source.name + "</a>";
                  sourceUnorderedList.appendChild(sourceListItem)
                });
            }

            sourceListContainer.appendChild(sourceUnorderedList);

            var counterField = document.getElementById("source-tracking-counter");
            counterField.value = sourcesCounter;
        }

        if (documentType === "page" && data.data.pages[0]) {
          // hide the source tracking form
          var sourceListContainer = document.getElementById('sources-list-container');
          sourceListContainer.style.display = "none";
          var addSourceButton = document.getElementById('add-another-source');
          addSourceButton.style.display = "none";

          typeHiddenField.value = documentType;
          pageId = data.data.pages[0].id;
          // console.log("hasuraGetPage id:", pageId);
          if (
            data.data.pages[0] && 
            data.data.pages[0].page_google_documents && 
            data.data.pages[0].page_google_documents[0] && 
            data.data.pages[0].page_google_documents[0].google_document) {
              localeCode = data.data.pages[0].page_google_documents[0].google_document.locale_code;
            }
        }

        if (articleId && localeCode) {
          google.script.run.withFailureHandler(onFailure).withSuccessHandler(onSuccessGetArticle).hasuraGetTranslations(articleId, localeCode);
        } else if (pageId && localeCode) {
          console.log("page id found, getting translations...")
          google.script.run.withFailureHandler(onFailure).withSuccessHandler(onSuccessGetArticle).hasuraGetTranslations(pageId, localeCode);
        } else {

          console.log("no article or page ID found, locale is " + localeCode)
          if (data && data.data && data.data.headline) {
            // console.log("setting default article headline to:", data.data.headline)
            var headline = document.getElementById('article-headline');
            headline.value = data.data.headline;
            var searchTitle = document.getElementById('article-search-title');
            searchTitle.value = data.data.headline;
          } else {
            // console.log("data.headline is undefined:", data);
          }
          var configDiv = document.getElementById('config');
          configDiv.style.display = 'none';

          var div = document.getElementById('loading');
          div.style.display = 'block';
          div.innerHTML = data.message;
          var form = document.getElementById('article-form');
          form.style.display = "block";
          var buttonsDivBottom = document.getElementById('action-buttons-bottom')
          buttonsDivBottom.style.display = "block";
          var buttonsDivTop = document.getElementById('action-buttons-top')
          buttonsDivTop.style.display = "block";
          setPublishedFlag(false); // new article is not published, ensure correct action buttons display

          displayLocales(data.data.organization_locales, localeCode);
          
          if (documentType === "article") {
            // console.log("data:", data);
            if (data && data.data && data.data.categories) {
              displayCategories(data.data.categories, null);
            }
            if (data && data.data && data.data.tags) {
              displayTags(data.data.tags, null);
            }
            if (data && data.data && data.data.authors) {
              displayAuthors(data.data.authors, null);
            }

            var today = new Date();
            flatpickr('input[name="article-first-published-date"]', {
              enableTime: true,
              dateFormat: "Y-m-d h:i K",
              defaultDate: today
            });

            $('#article-authors').select2({
              width: 'resolve',
            });

            $('#article-tags').select2({
              width: 'resolve',
              tags: true,
              createTag: function (params) {
                var term = $.trim(params.term);

                if (term === '') {
                  return null;
                }

                return {
                  id: term,
                  text: term,
                  newTag: true // add additional parameters
                }
              }
            });
          } else {
            [].forEach.call(document.querySelectorAll('.articles-only'), function (el) {
              el.style.display = 'none';
            });
          }
        }
      }

      function handleGetArticle() {
         google.script.run.withFailureHandler(onFailure).withSuccessHandler(handleGetTranslationsForArticle).hasuraGetArticle();
      }

      function displayTranslationTools(id, documentId, documentType, headline, googleDocs, organizationLocales) {
        console.log("displaying translation tools:", id, documentId, headline, googleDocs, organizationLocales);

        var existingDocsOtherLocales = [];
        var availableLocales = [];

        var selectedLocale = document.getElementById('article-locale').value;

        console.log("organizationLocales:", organizationLocales)
        if (googleDocs) {
          organizationLocales.forEach( (orgLocale) => {
            var foundLocaleDoc = false;
            // loop over each google doc associated with this article
            googleDocs.forEach( (doc) => {
              // if google doc is not the current one we have open...
              if (doc.google_document.document_id !== documentId) {
                // ... and this org locale is equal to the google doc's locale
                if (orgLocale.locale.code === doc.google_document.locale_code) {
                  // add it to the list of documents available that are translations of this article
                  existingDocsOtherLocales.push(doc.google_document);
                  foundLocaleDoc = true;
                }
              // current document
              } else {
                if (orgLocale.locale.code === doc.google_document.locale_code) {
                  foundLocaleDoc = true;
                }
              }
            });
            // if we didn't find a google document for this org locale, mark it as available
            if (!foundLocaleDoc) {
              availableLocales.push(orgLocale.locale);
            }
          })

          console.log("availableLocales:", availableLocales, "existingDocsOtherLocales:", existingDocsOtherLocales);

          if (availableLocales && availableLocales.length > 0) {
            availableLocales.forEach(availableLocale => {
              if (availableLocale.code !== selectedLocale) {
                // TODO: make another version of this button for the bottom of the sidebar?
                var buttonId = "translate-button-top-" + availableLocale.code;
                if (!document.getElementById(buttonId)) { // avoid adding multiple instances of the same button
                  var button = document.createElement("button");
                  button.setAttribute("class", "blue");
                  button.setAttribute("type", "button");
                  button.setAttribute("id", buttonId);
                  button.setAttribute("data-headline", headline);
                  button.setAttribute("data-doc-type", documentType);
                  if (documentType === "page") {
                    button.setAttribute("data-page-id", id);
                  } else {
                    button.setAttribute("data-article-id", id);
                  }
                  button.setAttribute("data-locale", availableLocale.code);
                  button.setAttribute("onClick", "handleCreateDoc(this)");
                  button.innerHTML = 'Translate to ' + availableLocale.name;
                  console.log(availableLocale, "button:", button);
                  var buttonsTopContainer = document.getElementById('action-buttons-top');
                  buttonsTopContainer.appendChild(button);
                }
              }
            })
          }

          if (existingDocsOtherLocales.length > 0) {
            existingDocsOtherLocales.forEach(doc => {
              console.log("existing doc:", doc)
              if (doc.locale.code !== selectedLocale) {
                
                var buttonId = "translate-button-top-" + doc.locale.code;
                if (!document.getElementById(buttonId)) { // avoid adding multiple instances of the same button
                  var button = document.createElement("button");
                  button.setAttribute("id", buttonId);
                  button.setAttribute("class", "blue");
                  button.setAttribute("type", "button");
                  var buttonOpenLink = "window.open('" + doc.url + "', '_blank')";
                  button.setAttribute("onClick", buttonOpenLink);
                  button.innerHTML = "Open in " + doc.locale.name;
                  var buttonsTopContainer = document.getElementById('action-buttons-top');
                  buttonsTopContainer.appendChild(button);
                }
              }
            });
          }
        }
      }

      function onSuccessPreviewPublish(response) {
        var configDiv = document.getElementById('config');
        configDiv.style.display = 'none';
        var div = document.getElementById('loading');
        div.style.display = 'block';

        if (response.status === "error" || response.data.errors) {
          let errorMessage;
          if (response.status === "error") {
            errorMessage = response.message;
          } else {
            errorMessage = JSON.stringify(response.data.errors);
          }
          div.innerHTML = "<p class='error'>An error occurred: " + errorMessage + '</p>';

        } else {
          div.innerHTML = '<p style="color: #48C774;">' + response.message + "</p>";
          if (response.data && response.data.data && response.data.data.insert_articles) {
            var articleID = response.data.data.insert_articles.returning[0].id;
            var idHiddenField = document.getElementById('article-id');
            idHiddenField.value = articleID;

            var articleSlug = response.data.data.insert_articles.returning[0].slug;
            var slugField = document.getElementById('article-slug');
            slugField.value = articleSlug;

            var articleID = response.data.data.insert_articles.returning[0].id;
            var idHiddenField = document.getElementById('article-id');
            idHiddenField.value = articleID;

            var translations = response.data.data.insert_articles.returning[0].article_translations;
            if (translations[0]) {
              setPublishedFlag(translations[0].published);
            }
            var publishedInfo = response.data.data.insert_articles.returning[0].published_article_translations;
            if (publishedInfo && publishedInfo[0]) {
              var mostRecentPubInfo = publishedInfo[0].article_translation;
              displayPublishedInfo(mostRecentPubInfo, translations[0]);
              
              console.log("publishedInfo:", mostRecentPubInfo);
              if (mostRecentPubInfo) {
                var firstPubDate = new Date(mostRecentPubInfo.first_published_at);
                console.log("setting published date to ", firstPubDate, mostRecentPubInfo.first_published_at);
                flatpickr('input[name="article-first-published-date"]', {
                  enableTime: true,
                  dateFormat: "Y-m-d h:i K",
                  defaultDate: firstPubDate
                });
              } else {
                var today = new Date();
                flatpickr('input[name="article-first-published-date"]', {
                  enableTime: true,
                  dateFormat: "Y-m-d h:i K",
                  defaultDate: today
                });
              }
            }

            console.log("response:", response);
            var googleDocs = response.data.data.insert_articles.returning[0].article_google_documents;
            var organizationLocales = response.data.organization_locales;
            var documentID = response.documentID;
            console.log("googleDocs:", googleDocs, "organizationLocales:", organizationLocales, "documentID:", documentID);
        
            displayTranslationTools(articleID, documentID, "article", translations[0].headline, googleDocs, organizationLocales);

          } else if (response.data && response.data.data && response.data.data.insert_pages) {
            var pageData = response.data.data.insert_pages.returning[0];
            console.log("pageData:", pageData);

            var pageID = pageData.id;
            // console.log("page ID:", pageID)
            var idHiddenField = document.getElementById('article-id');
            idHiddenField.value = pageID;

            var googleDocs = pageData.page_google_documents;
            var organizationLocales = response.data.organization_locales;
            var documentID = response.documentID;

            var translations = pageData.page_translations;
            console.log("page translations:", translations);
            if (translations[0]) {
              displayTranslationTools(pageID, documentID, "page", translations[0].headline, googleDocs, organizationLocales);
            }

          } else if (response.data && response.data.data && response.data.data.update_article_translations) {
            // console.log("unpublished article:", response.data);
            setPublishedFlag(false);
          } else {
            console.log("unknown: ", response);
          }
        }

        var form = document.getElementById('article-form');
        form.style.display = "block";
      }

      function handleClick(formObject) {
        var form = document.getElementById('article-form');
        form.style.display = "none";

        var formIsValid = true;

        var configDiv = document.getElementById('config');
        configDiv.style.display = "none";

        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "block";

        var errorMessage = "";

        var typeHiddenField = document.getElementById('document-type');
        var documentType = typeHiddenField.value;

        var headline = document.getElementById('article-headline');
        var searchTitle = document.getElementById('article-search-title');
        var searchDescription = document.getElementById('article-search-description');

        var sources = {};

        if (documentType !== "page")  {

          var elements = formObject.elements;

          // build up an object with source data
          // keys are source ids
          for (var i = 0, element; element = elements[i++];) {
            var elementMatch = element.name.match(/source\[(.*?)\]\.(.*?)$/);
            if (elementMatch) {
              var id = elementMatch[1];
              if (sources[id] === undefined) {
                sources[id] = {};
              }
              var fieldName = elementMatch[2];
              var value = element.value;
              sources[id][fieldName] = value
            }
          }
          // loop over sources and check that each has either an email or phone specified
          Object.keys(sources).forEach(id => {
            var email = sources[id]['email'];
            var phone = sources[id]['phone'];
            var name = sources[id]['name'];
            
            // name is required
            if (!/new_/.test(id) && !name) {
              errorMessage += "<br>'Name' is required on all sources.";
              delete sources[id];
              formIsValid = false;

            // new source form that lacks a name, email and phone should be omitted
            } else if (/new_/.test(id) && (!name && !email && !phone) ) {
              // remove blank source from the list
              delete sources[id];
              // console.log(sources);

            } else {
              if (name && (phone || email)) {
                // console.log(name, "has a name + a phone or email:", phone, email);
              } else if (!name) {
                // console.log("source is missing a name")
                errorMessage += "<br>'Name' is required on all sources.";
                delete sources[id];
                formIsValid = false;
              } else {
                // console.log(id, name, "is missing a phone/email")
                delete sources[id];
                errorMessage += "<br>All sources must have either a phone or email.";
                formIsValid = false;
              }
            }
          })

          var selectedAuthors = $('#article-authors').select2('data')
          var customByline = document.getElementById("article-custom-byline").value;
          if ( (selectedAuthors === undefined || selectedAuthors.length <= 0) && ( customByline === null || customByline === undefined || customByline === "") ) {
            // console.log("selectedAuthors:", selectedAuthors, "customByline:", customByline)
            errorMessage += "<br>Author or custom byline is required.";
            formIsValid = false;
          }
        }
        if (!headline.value) {
          // console.log("headline is missing:", headline.value, typeof(headline.value));
          errorMessage += "<br>Headline is required.";
          formIsValid = false;
        }
        if (!searchTitle.value) {
          // console.log("search title is missing:", searchTitle.value, typeof(searchTitle.value));
          errorMessage += "<br>Search title is required.";
          formIsValid = false;
        }
        if (!searchDescription.value) {
          // console.log("searchDescription is missing:", searchDescription.value, typeof(searchDescription.value));
          errorMessage += "<br>Search description is required.";
          formIsValid = false;
        }

        // assemble the data to submit - unfortunately we can't pass the form object with any additional data here
        var submitData = {};
        var elements = formObject.elements;
        for (var i = 0, element; element = elements[i++];) {
          var key = element.name;
          var value = element.value;
          if ( !(/source/).test(key) ) {
            submitData[key] = value;
          }
        }
        if (documentType === "article") {
          var selectedTags = $('#article-tags').select2('data');
          submitData["article-tags"] = [];
          for (var i = 0, tag; tag = selectedTags[i++];) {
            submitData["article-tags"].push(tag.text);
          }

          const calendar = flatpickr('input[name="article-first-published-date"]', {enableTime: true,
            dateFormat: "Y-m-d h:i K"});
        
          var publishedDate = calendar.selectedDates[0];
          // 2018-08-28T12:30:00+05:30
          // var formattedPubDate = calendar.formatDate(publishedDate, "y-m-dT")
          console.log("storing pub date as:", publishedDate);

          var formattedPubDate = toIsoString(publishedDate);
          submitData["first-published-at"] = formattedPubDate;
          console.log('formattedPubDate:', formattedPubDate);
          submitData["sources"] = sources;
        }
        
        if (formIsValid && formObject.submitted === "Preview") {
          // console.log("valid form + preview")
          loadingDiv.innerHTML = "<p class='gray'>Loading preview...</p>"
          google.script.run.withSuccessHandler(onSuccessPreviewPublish).withFailureHandler(onFailure).hasuraHandlePreview(submitData);
        } else if ( formIsValid && (formObject.submitted === "Publish" || formObject.submitted === "Re-publish") ) {
          // console.log("valid form + ", formIsValid, formObject.submitted)
          if (documentType === "article" && $.isEmptyObject(sources)) {
            if (!window.confirm("You're trying to publish an article without any source tracking info: are you sure?")) { 
              form.style.display = "block";
              loadingDiv.innerHTML = "Please enter source tracking info, then try publishing again.";
              const redrawCalendar = flatpickr('input[name="article-first-published-date"]', {
                enableTime: true,
                dateFormat: "Y-m-d h:i K",
              });

            } else {
              loadingDiv.innerHTML = "<p class='gray'>Publishing without any sources... </p>"
              google.script.run.withSuccessHandler(onSuccessPreviewPublish).withFailureHandler(onFailure).hasuraHandlePublish(submitData);
            }
          } else {
            loadingDiv.innerHTML = "<p class='gray'>Publishing... </p>"
            google.script.run.withSuccessHandler(onSuccessPreviewPublish).withFailureHandler(onFailure).hasuraHandlePublish(submitData);
          }
        } else if ( documentType === "article" && formIsValid && formObject.submitted === "Unpublish") {
          // console.log("valid form + unpublish")
          loadingDiv.innerHTML = "<p class='gray'>Unpublishing article... </p>"
          var articleId = document.getElementById('article-id').value;
          var selectedLocale = document.getElementById('article-locale').value;

          google.script.run.withSuccessHandler(onSuccessPreviewPublish).withFailureHandler(onFailure).hasuraHandleUnpublish(formObject);
        } else {
          // console.log("invalid form")
          if (errorMessage !== "") {
            loadingDiv.innerHTML = "<p class='error'>" + errorMessage + "</p>"
          } else {
            loadingDiv.innerHTML = "<p class='error'>Please make sure all required fields are filled in.</p>"
          }
          form.style.display = "block";
        }
      }
      window.onload = (function(){
        var form = document.getElementById('article-form');
        form.style.display = "none";

        var buttonsDivBottom = document.getElementById('action-buttons-bottom')
        buttonsDivBottom.style.display = "none";
        var buttonsDivTop = document.getElementById('action-buttons-top')
        buttonsDivTop.style.display = "none";

        handleGetArticle();
      });

      // Prevent forms from submitting.
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }

      window.addEventListener('load', preventFormSubmit);
    </script>

    <style>
      textarea {
        width: 100%;
      }
      .branding-below {
        bottom: 56px;
        top: 0;
      }
      input[type="text"] {
        width: 100%;
      }
      .button, button, input[type="button"] {
        min-width: 0 !important;
      }

      input:invalid {
        border: 1px dashed red;
      }

      input:invalid:required, textarea:invalid:required {
        border: 1px solid red;
      }
      #published-info {
        display: none;
      }

    </style>
  </head>

  <body>
    <a id='top' href="#"></a>
    <div id="sidebar-wrapper" class="sidebar branding-below">
      <h1 class="title">Publishing Tools</h1>

      <div class="block gray" id="loading">Loading...</div>

      <div id="config"></div>

      <div class="block" id="featured"></div>

      <div id="article-form">
        <form onsubmit="handleClick(this)">
          <div class="block" id="action-buttons-top">
            <input type="submit" name="preview" id="preview-button-top" class="blue" value="Preview" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="publish-button-top" value="Publish" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="unpublish-button-top" value="Unpublish" onclick="this.form.submitted=this.value;"/>
          </div>

          <div class="block form-group">
            <label for="article-locale">
              <b>Locale</b>
            </label>
            <select style="width: 100%" id="article-locale" name="article-locale"></select>
          </div>

          <div class="block form-group">
            <label for="article-slug">
              <b>Article slug</b>
            </label>
            <input type="hidden" id="article-id" name="article-id" />
            <input id="article-slug" name="article-slug" type="text" />
            <input type="hidden" id="document-type" name="document-type" />
          </div>

          <div class="block form-group">
            <label for="article-headline">
              <b>Headline</b> <i>(required)</i>
            </label>
            <input id="article-headline" name="article-headline" type="text" />
          </div>

          <div class="block form-group articles-only">
            <label for="article-authors">
              <b>Authors</b>
              <select style="width: 100%" id="article-authors" name="article-authors" multiple="multiple"></select>
            </label>
          </div>

          <div class="block form-group articles-only">
            <label for="article-custom-byline">
              <b>Custom Byline</b>
            </label>
            <input id="article-custom-byline" name="article-custom-byline" type="text" />
          </div>

          <div class="block form-group articles-only">
            <label for="article-category">
              <b>Category/Section</b> <i>(required)</i>
              <select style="width: 100%" id="article-category" name="article-category"></select>
            </label>
          </div>

          <div class="block form-group articles-only">
            <label for="article-tags">
              <b>Tags</b>
              <select style="width: 100%" id="article-tags" name="article-tags" multiple="multiple"></select>
            </label>
          </div>

          <div class="block form-group">
            <label for="article-search-title">
              <b>Search title</b> <i>(required)</i>
            </label>
            <input id="article-search-title" name="article-search-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-search-description">
              <b>Search description</b> <i>(required)</i>
            </label>
            <textarea id="article-search-description" name="article-search-description"></textarea>
          </div>
          <div class="block form-group">
            <label for="article-facebook-title">
              <b>Facebook title</b>
            </label>
            <input id="article-facebook-title" name="article-facebook-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-facebook-description">
              <b>Facebook description</b>
            </label>
            <textarea id="article-facebook-description" name="article-facebook-description"></textarea>
          </div>
          <div class="block form-group">
            <label for="article-twitter-title">
              <b>Twitter title</b>
            </label>
            <input id="article-twitter-title" name="article-twitter-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-twitter-description">
              <b>Twitter description</b>
            </label>
            <textarea id="article-twitter-description" name="article-twitter-description"></textarea>
          </div>

          <div class="block form-group articles-only">
            <label for="article-first-published-date">
              <b>Published Date</b>
            </label>

            <input type="text" name="article-first-published-date">
          </div>


          <div id="sources-list-container" class="block form-group">
            <h2 class="title">Source Tracking</h2>

          </div>

          <div id="sources-container" class="articles-only">
            <input type="hidden" name="source-tracking-counter" value="0" id="source-tracking-counter" />
          </div>

          <div class="block">
            <p>
              <button id="add-another-source" name="add-another-source" type="button" onClick="addAnotherSourceForm()">Add another source</button>
            </p>
          </div>

          <hr class="block" />

          <div class="block" id="action-buttons-bottom">
            <input type="submit" name="preview" id="preview-button-bottom" class="blue" value="Preview" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="publish-button-bottom" value="Publish" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="unpublish-button-bottom" value="Unpublish" onclick="this.form.submitted=this.value;"/>
          </div>

          <div class="block" id="published-info">
            <div class="small" id="translation-id"></div>
            <div class="small" style="width: 100%" id="published-info-first"><b>Initial:</b> <span id="first-published-at"></span></div>
            <div class="small" style="width: 100%" id="published-info-last"><b>Updated:</b> <span id="last-published-at"></span></div>
          </div>
        </form>
      </div>

      <div id="edit-links" class="block">
      </div>

      <div id="output" class="block"></div>

    </div>

    <div class="sidebar bottom">
      <span class="gray">
        Powered by News Catalyst
      </span>
    </div>

  </body>
</html>


