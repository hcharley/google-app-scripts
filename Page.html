<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

    <script>
      function onSuccess(contents) {
        // first, switch the "published" text to say "No"
        // because the headline and/or byline has likely changed.
        setPublishedFlag(false);
        var configDiv = document.getElementById('config');
        configDiv.display = 'none';
        var div = document.getElementById('form-output');
        div.innerHTML = contents;
        handleMeta();
      }
      
      function onFailureMeta(error) {
        var loadingDiv = document.getElementById('loading');
        console.log(error);
        loadingDiv.innerHTML = "An error occurred: " + error;
      }

      function onSuccessMeta(data) {
        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "none";

        var form = document.getElementById('article-meta-form');
        form.style.display = "block";

        var articleCategorySelect = document.getElementById('article-category');
        var categoriesSorted = data.categories.sort(function (a, b) {
          let comparison = 0;
          if (a.title.value > b.title.value) {
            comparison = 1;
          } else if (a.title.value < b.title.value) {
            comparison = -1;
          }
          return comparison;
        });
        categoriesSorted.forEach(category => {
          // first check if this option already exists; don't add dupes!
          var selectorString = "#article-category option[value='" + category.id + "']";
          if ( $(selectorString).length <= 0 ) {
            var option = document.createElement("option");
            option.text = category.title.value;
            option.value = category.id;

            if (data.categoryID !== null && data.categoryID == category.id) {
              option.selected = true;
            }
            articleCategorySelect.add(option);
          }
        })

        var articleTagsSelect = document.getElementById('article-tags');
        data.allTags.forEach(tag => {
          // first check if this option already exists; don't add dupes!
          var selectorString = "#article-tags option[value='" + tag.id + "']";
          if ( $(selectorString).length <= 0 ) {
            var option = document.createElement("option");
            option.text = tag.title.value;
            option.value = tag.id;

            const result = data.articleTags.find( ({ id }) => id === tag.id );
            if (result !== undefined) {
              option.selected = true;
            }
            articleTagsSelect.add(option);
          }
        })

        var revisionIdSpan = document.getElementById('revision-id');
        revisionIdSpan.innerHTML = data.articleID;

        setPublishedFlag(data.isPublished);

        var articleHeadline = document.getElementById('article-headline');
        articleHeadline.value = data.headline;

        var articleByline = document.getElementById('article-byline');
        articleByline.value = data.byline;

        var articleSearchTitle = document.getElementById('article-search-title');
        articleSearchTitle.value = data.seo.searchTitle;

        var articleSearchDescription = document.getElementById('article-search-description');
        articleSearchDescription.value = data.seo.searchDescription;

        var articleFacebookTitle = document.getElementById('article-facebook-title');
        articleFacebookTitle.value = data.seo.facebookTitle;

        var articleFacebookDescription = document.getElementById('article-facebook-description');
        articleFacebookDescription.value = data.seo.facebookDescription;

        var articleTwitterTitle = document.getElementById('article-twitter-title');
        articleTwitterTitle.value = data.seo.twitterTitle;

        var articleTwitterDescription = document.getElementById('article-twitter-description');
        articleTwitterDescription.value = data.seo.twitterDescription;

        var slugDiv = document.getElementById('slug');
        slugDiv.innerHTML = data.slug;

        $('#article-tags').select2({
          width: 'resolve',
          tags: true,
          createTag: function (params) {
            var term = $.trim(params.term);

            if (term === '') {
              return null;
            }

            return {
              id: term,
              text: term,
              newTag: true // add additional parameters
            }
          }
        });

        
        var revisionDiv = document.getElementById('revision-info');
        revisionDiv.style.display = "block";

        var saveDivTop = document.getElementById('save-article-top');
        saveDivTop.style.display = "block";

        var saveDivBottom = document.getElementById('save-article-bottom');
        saveDivBottom.style.display = "block";

        if (data.publishingInfo !== null && typeof(data.publishingInfo) !== 'undefined') {
          if (data.publishingInfo.firstPublishedOn !== null && typeof(data.publishingInfo.firstPublishedOn) !== 'undefined') {
            var firstPubDiv = document.getElementById('first-published');
            firstPubDiv.innerHTML = data.publishingInfo.firstPublishedOn;
          }

          if (data.publishingInfo.lastPublishedOn !== null && typeof(data.publishingInfo.lastPublishedOn) !== 'undefined') {
            var lastPubDiv = document.getElementById('last-published');
            lastPubDiv.innerHTML = data.publishingInfo.lastPublishedOn;
          }

        }
      }

      function displayConfigFormMessage(text) {
        var div = document.getElementById('script-config-form-output');
        div.innerHTML = text;

        var scriptForm = document.getElementById('script-config-form')
        scriptForm.display = "none";
      }

      function setPublishedFlag(value) {
        var isPublishedSpan = document.getElementById('is-published');
        var isPublishedYesNo = "no";
        if (value) {
          isPublishedYesNo = "yes";
        }
        isPublishedSpan.innerHTML = isPublishedYesNo;
      }

      function onSuccessConfig(data) {
        var configDiv = document.getElementById('config');
        if (data !== null && data !== {} && Object.keys(data).length > 0) {
          var scriptForm = document.getElementById('script-config-form')
          scriptForm.display = "none";
          // configDiv.innerHTML = "<div class='gray secondary'>Loaded script config, just FYI. You're ready to publish!</div><hr/>"
        } else {
          var scriptForm = document.getElementById('script-config-form')
          scriptForm.display = "block";
          configDiv.innerHTML = "<div class='error'>No script config found. Fill in the form.</div><hr/>"
        }
      }

      function onFailureConfig(error) {
        var configDiv = document.getElementById('config');
        configDiv.innerHTML = "An error occurred. This may be due to being logged into multiple google accounts at once. Try opening this doc in an incognito window.";
      }

      function handleScriptConfig() {
         google.script.run.withFailureHandler(onFailureConfig).withSuccessHandler(onSuccessConfig).getScriptConfig();
      }

      function handleMeta() {
         google.script.run.withFailureHandler(onFailureMeta).withSuccessHandler(onSuccessMeta).getArticleMeta();
      }

      function handleClick(formObject) {
        var form = document.getElementById('article-meta-form');
        form.style.display = "none";

        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "block";

        google.script.run.withSuccessHandler(onSuccess).getCurrentDocContents(formObject);
      }
      
      window.onload = (function(){
        var form = document.getElementById('article-meta-form');
        form.style.display = "none";
        
        var revisionDiv = document.getElementById('revision-info');
        revisionDiv.style.display = "none";

        var saveDivTop = document.getElementById('save-article-top');
        saveDivTop.style.display = "none";

        var saveDivBottom = document.getElementById('save-article-bottom');
        saveDivBottom.style.display = "none";

        handleScriptConfig();

        handleMeta();
      });

      function handleScriptConfigSubmit(formObject) {
        google.script.run.withSuccessHandler(displayConfigFormMessage).setScriptConfig(formObject);
      }

      // Prevent forms from submitting.
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', preventFormSubmit);


    </script>
    <style>
      .branding-below {
        bottom: 56px;
        top: 0;
      }
      input[type="text"] {
        width: 100%;
      }
      .button, button, input[type="button"] {
        min-width: 0 !important;
      }
      </style>

  </head>
  <body>
    <a id='top' href="#"></a>
    <div id="sidebar-wrapper" class="sidebar branding-below">
      <h1 class="title">Publishing Tools</h1>

      <div class="block" id="loading">Loading...</div>

      <div id="config"></div>
      <form id="script-config-form" style="display: none;" onsubmit="handleScriptConfigSubmit(this)">
        <div id="script-config-form-output" class="block secondary"></div>
        <div class="block form-group">
          <label for="access-token">
            <b>Content API Access Token</b>
          </label>
          <input id="access-token" name="ACCESS_TOKEN" type="text" />
        </div>
        <div class="block form-group">
          <label for="content-api">
            <b>Content API URL</b>
          </label>
          <input id="content-api" name="CONTENT_API" type="text" />
        </div>
        <div class="block form-group">
          <label for="personal-access-token">
            <b>GraphQL API Access Token</b>
          </label>
          <input id="personal-access-token" name="PERSONAL_ACCESS_TOKEN" type="text" />
        </div>
        <div class="block form-group">
          <label for="graphql-api-url">
            <b>GraphQL API URL</b>
          </label>
          <input id="graphql-api-url" name="GRAPHQL_API" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-access-key">
            <b>AWS Access Key ID</b>
          </label>
          <input id="aws-access-key" name="AWS_ACCESS_KEY_ID" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-secret-key">
            <b>AWS Secret Key</b>
          </label>
          <input id="aws-secret-key" name="AWS_SECRET_KEY" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-bucket">
            <b>AWS Bucket</b>
          </label>
          <input id="aws-bucket" name="AWS_BUCKET" type="text" />
        </div>
        <div class="block">
          <button class="blue">Submit</button>
        </div>
      </form>

      <div id="article-meta-form">
        <form onsubmit="handleClick(this)">
          <div id="form-output" class="block success"></div>
          <div id="save-article-top" class="block">
            <input type="submit" class="blue" value="Save & Publish Article"/>
          </div>

          <div class="block form-group">
            <label for="article-headline">
              <b>Headline</b>
            </label>
            <input id="article-headline" name="article-headline" type="text" />
          </div>

          <div class="block form-group">
            <label for="article-byline">
              <b>Byline</b>
            </label>
            <input id="article-byline" name="article-byline" type="text" />
          </div>

          <div class="block form-group">
            <label for="article-category">
              <b>Category/Section</b>
              <select style="width: 100%" id="article-category" name="article-category"></select>
            </label>
          </div>

          <div class="block form-group">
            <label for="article-tags">
              <b>Tags</b>
              <select style="width: 100%" id="article-tags" name="article-tags" multiple="multiple"></select>
            </label>
          </div>
          <div class="block form-group">
            <label for="article-search-title">
              <b>Search title</b>
            </label>
            <input id="article-search-title" name="article-search-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-search-description">
              <b>Search description</b>
            </label>
            <input id="article-search-description" name="article-search-description" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-facebook-title">
              <b>Facebook title</b>
            </label>
            <input id="article-facebook-title" name="article-facebook-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-facebook-description">
              <b>Facebook description</b>
            </label>
            <input id="article-facebook-description" name="article-facebook-description" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-twitter-title">
              <b>Twitter title</b>
            </label>
            <input id="article-twitter-title" name="article-twitter-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-twitter-description">
              <b>Twitter description</b>
            </label>
            <input id="article-twitter-description" name="article-twitter-description" type="text" />
          </div>
          <div id="save-article-bottom" class="block">
            <input type="submit" class="blue" value="Save & Publish Article"/>
          </div>
        </form>
      </div>

      <div class="block">
        <div id="revision-info">
          <p>
            <b>Article slug:</b> <span id="slug"></span>
          </p>
          <p>
            <b>Revision ID:</b> <span id="revision-id"></span>
          </p>
          <p>
            <b>Published?</b> <span id="is-published"></span>
          </p>
          <p>
            <b>First published:</b> <span id="first-published"></span>
          </p>
          <p>
            <b>Last published:</b> <span id="last-published"></span>
          </p>
        </div>
      </div>

      <div id="output" class="block"></div>
    </div>

    <div class="sidebar bottom">
      <span class="gray">
        Powered by News Catalyst
      </span>
    </div>

  </body>
</html>


