<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

    <script>
      // flags for a subset of all locales
      // I started with the ones I figured were the most likely; then grabbed more from this
      // full locale list from https://github.com/ladjs/i18n-locales
      // emoji flags from https://emojipedia.org/flags/
      // I took all the major seeming english variants too: Australia, Canada, Ireland, GB, NZ, US, and South Africa
      const emojiFor = {
        "es": "ðŸ‡ªðŸ‡¸",
        "es-ES": "ðŸ‡ªðŸ‡¸",
        "fr": "ðŸ‡«ðŸ‡·",
        "fr-FR": "ðŸ‡«ðŸ‡·",
        "de": "ðŸ‡©ðŸ‡ª",
        "de-DE": "ðŸ‡©ðŸ‡ª",
        "pt-BR": "ðŸ‡§ðŸ‡·",
        "pt": "ðŸ‡µðŸ‡¹",
        "pt-PT": "ðŸ‡µðŸ‡¹",
        "en": "ðŸ‡¬ðŸ‡§",
        "en-AU": "ðŸ‡¦ðŸ‡º",
        "en-CA": "ðŸ‡¨ðŸ‡¦",
        "en-IE": "ðŸ‡®ðŸ‡ª",
        "en-GB": "ðŸ‡¬ðŸ‡§",
        "en-US": "ðŸ‡ºðŸ‡¸",
        "en-NZ": "ðŸ‡³ðŸ‡¿",
        "en-ZA": "ðŸ‡¿ðŸ‡¦",
        "jp": "ðŸ‡¯ðŸ‡µ",
        "zh": "ðŸ‡¨ðŸ‡³",
        "zh-CN": "ðŸ‡¨ðŸ‡³",
        "it": "ðŸ‡®ðŸ‡¹",
        "ru": "ðŸ‡·ðŸ‡º",
        "ru-RU": "ðŸ‡·ðŸ‡º"
      }

      function showConfigForm() {
        var scriptForm = document.getElementById('script-config-form')
        scriptForm.style.display = "block";
      }

      function hideConfigForm() {
        var scriptForm = document.getElementById('script-config-form')
        scriptForm.style.display = "none";
      }

      function onSuccessNewDoc(contents) {
        var configDiv = document.getElementById('config');
        configDiv.style.display = 'none';
        var div = document.getElementById('output');
        div.style.display = 'block';
        div.innerHTML = "<a href='https://docs.google.com/document/d/" + contents.docID + "/edit?parentID=" + contents.parentID + "' target='_blank'>Open new doc</a>";
      }

      function onSuccess(contents) {
        // first, switch the "published" text to say "No"
        // because the headline and/or byline has likely changed.
        setPublishedFlag(false);
        var configDiv = document.getElementById('config');
        configDiv.style.display = 'none';
        var div = document.getElementById('loading');
        div.style.display = 'block';
        if (contents && contents.status && contents.status === "error") {
          div.innerHTML = "<p class='error'>An error occurred: " + contents.message + '</p>';
        } else {
          div.innerHTML = '<p style="color: #48C774;">' + contents.message + "</p>";
        }
        handleMetaPreserveLoading();
      }
      
      function onFailureMeta(error) {
        var loadingDiv = document.getElementById('loading');
        console.log("onFailureMeta error:", error);
        loadingDiv.innerHTML = "<p class='error'>An error occurred: " + error + '</p>';
      }

      function onFailure(error) {
        console.log("onFailure error:", error);
        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "block";
        loadingDiv.innerHTML = "<p class='error'>An error occurred: " + error + "</p>";
      }

      function onSuccessPreviewPublish(response) {
        var configDiv = document.getElementById('config');
        configDiv.style.display = 'none';
        var div = document.getElementById('loading');
        div.style.display = 'block';
        if (response && response.status && response.status === "error") {
          div.innerHTML = "<p class='error'>An error occurred: " + response.message + '</p>';
        } else {
          div.innerHTML = '<p style="color: #48C774;">' + response.message + "</p>";
        }
        if (response.data) {
          onSuccessMetaPreserveLoading(response.data);
        }
      }

      function onSuccessMetaPreserveLoading(data) {
        console.log("onSuccessMeta data:", data);
        var form = document.getElementById('article-meta-form');
        form.style.display = "block";

        if (data.documentType !== "article") {
          var elements = document.getElementsByClassName('articles-only');
          for (var i = 0; i < elements.length; i++) {
            elements[i].style.display = "none";
          };
        }

        var articleLocaleSelect = document.getElementById('article-locale');
        if (data.localeName !== null && data.localeName !== undefined) {
          articleLocaleSelect.style.display = 'none';
          articleLocaleSelect.style.visibility = 'hidden';

          var selectedLocaleDiv = document.getElementById('selected-locale');
          selectedLocaleDiv.innerHTML = "<b>" + data.localeName + "</b>";

        } else {

          data.locales.forEach(locale => {
            // first check if this option already exists; don't add dupes!
            var selectorString = "#article-locale option[value='" + locale.id + "']";
            if ( $(selectorString).length <= 0 ) {
              var option = document.createElement("option");
              if (locale.code) {
                option.text = locale.code;
              } else {
                option.text = "(BUG) unknown locale";
              }
              // mark this locale as selected if it's the article's locale ID -or- is the default locale
              if (data.localeID !== null && data.localeID === locale.id) {
                option.selected = true;
              } else if (locale.default) {
                option.selected = true;
              }
              option.value = locale.id;

              articleLocaleSelect.add(option);
            }
          })
        }

        if (data.documentType === 'article') {
          var articleCategorySelect = document.getElementById('article-category');
          var categoriesSorted = data.categories.sort(function (a, b) {
            let comparison = 0;
            let aTitle, bTitle;
            if (a.title && a.title.values && a.title.values[0].value) {
              aTitle = a.title.values[0].value;
            }
            if (b.title && b.title.values && b.title.values[0].value) {
              bTitle = b.title.values[0].value;
            }
            if (aTitle > bTitle) {
              comparison = 1;
            } else if (aTitle < bTitle) {
              comparison = -1;
            }
            return comparison;
          });
          categoriesSorted.forEach(category => {
            // first check if this option already exists; don't add dupes!
            var selectorString = "#article-category option[value='" + category.id + "']";
            if ( $(selectorString).length <= 0 ) {
              var option = document.createElement("option");
              if (category.title && category.title.values && category.title.values[0].value) {
                option.text = category.title.values[0].value;
              } else {
                option.text = "(BUG) unknown title";
              }
              option.value = category.id;

              if (data.categoryID !== null && data.categoryID == category.id) {
                option.selected = true;
              }
              articleCategorySelect.add(option);
            }
          })

          var articleAuthorsSelect = document.getElementById('article-authors');
          data.allAuthors.forEach(author => {
            // first check if this option already exists; don't add dupes!
            var selectorString = "#article-authors option[value='" + author.id + "']";
            if ( $(selectorString).length <= 0 ) {
              var option = document.createElement("option");
              option.text = author.name;
              option.value = author.id;

              const result = data.articleAuthors.find( ({ id }) => id === author.id );
              if (result !== undefined) {
                option.selected = true;
              }
              articleAuthorsSelect.add(option);
            }
          })
        }

        var articleTagsSelect = document.getElementById('article-tags');
        data.allTags.forEach(tag => {
          // first check if this option already exists; don't add dupes!
          var selectorString = "#article-tags option[value='" + tag.id + "']";
          if ( $(selectorString).length <= 0 ) {
            var option = document.createElement("option");
            if (tag.title && tag.title.values && tag.title.values[0].value) {
              option.text = tag.title.values[0].value;
            } else {
              option.text = "(BUG) unknown title";
            }
            option.value = tag.id;

            const result = data.articleTags.find( ({ id }) => id === tag.id );
            if (result !== undefined) {
              option.selected = true;
            }
            articleTagsSelect.add(option);
          }
        })

        setPublishedFlag(data.published);

        var articleHeadline = document.getElementById('article-headline');
        articleHeadline.value = data.headline;

        if (data.documentType === 'article') {
          if (data.customByline !== null && data.customByline !== undefined) {
            var articleCustomByline = document.getElementById('article-custom-byline');
            articleCustomByline.value = data.customByline;
          }
        }

        if (data.seo.searchTitle !== undefined) {
          var articleSearchTitle = document.getElementById('article-search-title');
          articleSearchTitle.value = data.seo.searchTitle;
        }

        if (data.seo.searchDescription !== undefined) {
          var articleSearchDescription = document.getElementById('article-search-description');
          articleSearchDescription.value = data.seo.searchDescription;
        }

        if (data.seo.facebookTitle !== undefined) {
          var articleFacebookTitle = document.getElementById('article-facebook-title');
          articleFacebookTitle.value = data.seo.facebookTitle;
        }

        if (data.seo.facebookDescription !== undefined) {
          var articleFacebookDescription = document.getElementById('article-facebook-description');
          articleFacebookDescription.value = data.seo.facebookDescription;
        }

        if (data.seo.twitterTitle !== undefined) {
          var articleTwitterTitle = document.getElementById('article-twitter-title');
          articleTwitterTitle.value = data.seo.twitterTitle;
        }

        if (data.seo.twitterDescription !== undefined) {
          var articleTwitterDescription = document.getElementById('article-twitter-description');
          articleTwitterDescription.value = data.seo.twitterDescription;
        }

        var previewUrl = document.getElementById('preview-url');
        previewUrl.value = data.previewUrl;

        var previewSecret = document.getElementById('preview-secret');
        previewSecret.value = data.previewSecret;

        var slugDiv = document.getElementById('slug');
        slugDiv.innerHTML = data.slug;

        if (data.documentType === 'article') {
          $('#article-authors').select2({
            width: 'resolve',
          });

          $('#article-tags').select2({
            width: 'resolve',
            tags: true,
            createTag: function (params) {
              var term = $.trim(params.term);

              if (term === '') {
                return null;
              }

              return {
                id: term,
                text: term,
                newTag: true // add additional parameters
              }
            }
          });
        }

        var buttonsDivBottom = document.getElementById('action-buttons-bottom')
        buttonsDivBottom.style.display = "inline";
        var buttonsDivTop = document.getElementById('action-buttons-top')
        buttonsDivTop.style.display = "inline";

        // if (data.firstPublishedOn !== null && typeof(data.firstPublishedOn) !== 'undefined') {
        //   var firstPubDiv = document.getElementById('first-published');
        //   var localisedDate = new Date(data.firstPublishedOn).toLocaleString();
        //   firstPubDiv.innerHTML = localisedDate;
        // }

        // if (data.lastPublishedOn !== null && typeof(data.lastPublishedOn) !== 'undefined') {
        //   var lastPubDiv = document.getElementById('last-published');
        //   var localisedDate = new Date(data.lastPublishedOn).toLocaleString();
        //   lastPubDiv.innerHTML = localisedDate;
        // }

        if (data.googleDocs !== null && data.googleDocs !== undefined) {
          var editDiv = document.getElementById('edit-links');
          var createLinks = [];
          var editLinks = [];
          var createLocales = data.locales.map(locale=>locale.code);
          var existingLocales = Object.keys(data.googleDocs);

          createLocales = createLocales.filter(function(item) {
            return !existingLocales.includes(item); 
          })

          $.each( data.googleDocs, function( locale, docID ) {
            var emojiFlag = emojiFor[locale];
            if (locale !== data.localeName) {
              editLinks.push("<li><a target='_blank' href='https://docs.google.com/document/d/" + docID + "/edit'>" + emojiFlag + locale + "</a></li>")
            }
          });

          $.each(createLocales, function( index, locale ) {
            var emojiFlag = emojiFor[locale];
            createLinks.push("<li><a onclick='createNewDoc(\"" + locale + "\");'>" + emojiFlag + locale + "</li>");
          });

          if (createLinks.length > 0) {
            editDiv.innerHTML = "<p><b>Create new translation:</b></p><ul>" + createLinks.join("")+ "</ul>";
          }
          if (editLinks.length > 0) {
            editDiv.innerHTML += "<p><b>Existing translations:</b></p><ul>" + editLinks.join("")+ "</ul>";
          }
        }
      }

      function onSuccessMeta(data) {
        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "none";

        onSuccessMetaPreserveLoading(data);
      }

      function setPublishedFlag(value) {
        // var isPublishedSpan = document.getElementById('is-published');
        var isPublishedYesNo = "no";

        if (value === "true" || value === true) { // ðŸ˜­ javascript + JSON + boolean `published: true` or `published: false` as string
          isPublishedYesNo = "yes";

          var publishButtonTop = document.getElementById('publish-button-top');
          publishButtonTop.value = "Re-publish";
          var publishButtonBottom = document.getElementById('publish-button-bottom');
          publishButtonBottom.value = "Re-publish";

          // display the unpublish button
          var unpublishButtonTop = document.getElementById('unpublish-button-top');
          unpublishButtonTop.style.display = "inline";
          var unpublishButtonBottom = document.getElementById('unpublish-button-bottom');
          unpublishButtonBottom.style.display = "inline";

        } else {
          var publishButtonTop = document.getElementById('publish-button-top');
          publishButtonTop.value = "Publish";
          var publishButtonBottom = document.getElementById('publish-button-bottom');
          publishButtonBottom.value = "Publish";

          // hide the unpublish button
          var unpublishButtonTop = document.getElementById('unpublish-button-top');
          unpublishButtonTop.style.display = "none";
          var unpublishButtonBottom = document.getElementById('unpublish-button-bottom');
          unpublishButtonBottom.style.display = "none";
        }
        // isPublishedSpan.innerHTML = isPublishedYesNo;
      }

      function onSuccessConfig(data) {
        // hideLoading();
        var loadingDiv = document.getElementById('loading');
        if (data !== null && data !== {} && Object.keys(data).length > 0) {
          loadingDiv.innerHTML = "<div class='success'>Configuration loaded.</div><hr/>"
          hideConfigForm();
        } else {
          showConfigForm();
          loadingDiv.innerHTML = "<div class='error'>No script config found. Fill in the form to use publishing tools.</div><hr/>"
        }
      }

      function onFailureConfig(error) {
        var configDiv = document.getElementById('loading');
        configDiv.innerHTML = "<p class='error'>An error occurred. This may be due to being logged into multiple google accounts at once. Try opening this doc in an incognito window.</p>";
      }

      function createNewDoc(locale) {
         google.script.run.withFailureHandler(onFailure).withSuccessHandler(onSuccessNewDoc).createNewDoc(locale);
      }
      function handleScriptConfig() {
         google.script.run.withFailureHandler(onFailureConfig).withSuccessHandler(onSuccessConfig).getScriptConfig();
      }

      function handleMetaPreserveLoading() {
         google.script.run.withFailureHandler(onFailureMeta).withSuccessHandler(onSuccessMetaPreserveLoading).getArticleMeta();
      }

      function handleMeta() {
         google.script.run.withFailureHandler(onFailureMeta).withSuccessHandler(onSuccessMeta).getArticleMeta();
      }

      function handleClick(formObject) {
        var form = document.getElementById('article-meta-form');
        form.style.display = "none";

        var configDiv = document.getElementById('config');
        configDiv.style.display = "none";

        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "block";

        if (formObject.submitted === "Preview") {
          loadingDiv.innerHTML = "<p class='gray'>Loading preview...</p>"
          google.script.run.withSuccessHandler(onSuccessPreviewPublish).withFailureHandler(onFailure).handlePreview(formObject);
        } else if ( (formObject.submitted === "Publish") || (formObject.submitted === "Re-publish") ) {
          loadingDiv.innerHTML = "<p class='gray'>Publishing article...</p>"
          google.script.run.withSuccessHandler(onSuccessPreviewPublish).withFailureHandler(onFailure).handlePublish(formObject);
        } else {
          loadingDiv.innerHTML = "<p class='gray'>Unpublishing article...</p>"
          google.script.run.withSuccessHandler(onSuccessPreviewPublish).withFailureHandler(onFailure).handleUnpublish(formObject);
        }
      }
      
      window.onload = (function(){
        var form = document.getElementById('article-meta-form');
        form.style.display = "none";
        hideConfigForm();

        var buttonsDivBottom = document.getElementById('action-buttons-bottom')
        buttonsDivBottom.style.display = "none";
        var buttonsDivTop = document.getElementById('action-buttons-top')
        buttonsDivTop.style.display = "none";

        handleScriptConfig();

        handleMeta();


      });

      function displayConfigFormMessage(text) {
        var configDiv = document.getElementById('loading');
        configDiv.innerHTML = text;

        hideConfigForm();
      }

      function handleScriptConfigSubmit(formObject) {
        google.script.run.withSuccessHandler(displayConfigFormMessage).setScriptConfig(formObject);
      }

      // Prevent forms from submitting.
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', preventFormSubmit);


    </script>
    <style>
      .branding-below {
        bottom: 56px;
        top: 0;
      }
      input[type="text"] {
        width: 100%;
      }
      .button, button, input[type="button"] {
        min-width: 0 !important;
      }
      </style>

  </head>
  <body>
    <a id='top' href="#"></a>
    <div id="sidebar-wrapper" class="sidebar branding-below">
      <h1 class="title">Publishing Tools</h1>

      <div class="block gray" id="loading">Loading...</div>

      <div id="config"></div>
      <div id="script-config-form-output" class="block secondary"></div>
      <form id="script-config-form" onsubmit="handleScriptConfigSubmit(this)">
        <div class="block form-group">
          <label for="access-token">
            <b>Content API Access Token</b>
          </label>
          <input id="access-token" name="ACCESS_TOKEN" type="text" />
        </div>
        <div class="block form-group">
          <label for="content-api">
            <b>Content API URL</b>
          </label>
          <input id="content-api" name="CONTENT_API" type="text" />
        </div>
        <div class="block form-group">
          <label for="preview-url">
            <b>Preview Host URL</b>
          </label>
          <input id="preview-url" name="PREVIEW_URL" type="text" placeholder="http://localhost:3000/api/preview" />
        </div>
        <div class="block form-group">
          <label for="preview-secret">
            <b>Preview Secret Param</b>
          </label>
          <input id="preview-secret" name="PREVIEW_SECRET" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-access-key">
            <b>AWS Access Key ID</b>
          </label>
          <input id="aws-access-key" name="AWS_ACCESS_KEY_ID" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-secret-key">
            <b>AWS Secret Key</b>
          </label>
          <input id="aws-secret-key" name="AWS_SECRET_KEY" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-bucket">
            <b>AWS Bucket</b>
          </label>
          <input id="aws-bucket" name="AWS_BUCKET" type="text" />
        </div>
        <div class="block form-group">
          <label for="deploy-hook">
            <b>Vercel Deploy Hook</b>
          </label>
          <input id="deploy-hook" name="VERCEL_DEPLOY_HOOK_URL" type="text" />
        </div>
        <div class="block">
          <button class="blue">Save Config</button>
        </div>
      </form>

      <div id="article-meta-form">
        <form onsubmit="handleClick(this)">
          <div class="block" id="action-buttons-top">
            <input type="submit" name="preview" id="preview-button-top" class="blue" value="Preview" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="publish-button-top" value="Publish" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="unpublish-button-top" value="Unpublish" onclick="this.form.submitted=this.value;"/>
          </div>

          <div class="block form-group">
            <label for="article-locale">
              <b>Locale</b>
            </label>
            <div id="selected-locale"></div>
            <select style="width: 100%" id="article-locale" name="article-locale"></select>
          </div>

          <div class="block form-group">
            <label for="article-slug">
              <b>Article slug</b>
            </label>
            <div id="slug"></div>
          </div>

          <div class="block form-group">
            <label for="article-headline">
              <b>Headline</b>
            </label>
            <input id="article-headline" name="article-headline" type="text" />
          </div>

          <div class="block form-group articles-only">
            <label for="article-authors">
              <b>Authors</b>
              <select style="width: 100%" id="article-authors" name="article-authors" multiple="multiple"></select>
            </label>
          </div>

          <div class="block form-group articles-only">
            <label for="article-custom-byline">
              <b>Custom Byline</b>
            </label>
            <input id="article-custom-byline" name="article-custom-byline" type="text" />
          </div>

          <div class="block form-group articles-only">
            <label for="article-category">
              <b>Category/Section</b>
              <select style="width: 100%" id="article-category" name="article-category"></select>
            </label>
          </div>

          <div class="block form-group articles-only">
            <label for="article-tags">
              <b>Tags</b>
              <select style="width: 100%" id="article-tags" name="article-tags" multiple="multiple"></select>
            </label>
          </div>

          <div class="block form-group">
            <label for="article-search-title">
              <b>Search title</b>
            </label>
            <input id="article-search-title" name="article-search-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-search-description">
              <b>Search description</b>
            </label>
            <input id="article-search-description" name="article-search-description" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-facebook-title">
              <b>Facebook title</b>
            </label>
            <input id="article-facebook-title" name="article-facebook-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-facebook-description">
              <b>Facebook description</b>
            </label>
            <input id="article-facebook-description" name="article-facebook-description" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-twitter-title">
              <b>Twitter title</b>
            </label>
            <input id="article-twitter-title" name="article-twitter-title" type="text" />
          </div>
          <div class="block form-group">
            <label for="article-twitter-description">
              <b>Twitter description</b>
            </label>
            <input id="article-twitter-description" name="article-twitter-description" type="text" />
          </div>
          <div class="block" id="action-buttons-bottom">
            <input type="submit" name="preview" id="preview-button-bottom" class="blue" value="Preview" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="publish-button-bottom" value="Publish" onclick="this.form.submitted=this.value;"/>
            <input type="submit" class="blue" id="unpublish-button-bottom" value="Unpublish" onclick="this.form.submitted=this.value;"/>
          </div>
        </form>
      </div>

      <div id="edit-links" class="block">
      </div>

      <div id="output" class="block"></div>

    </div>

    <div class="sidebar bottom">
      <span class="gray">
        Powered by News Catalyst
      </span>
    </div>

  </body>
</html>


