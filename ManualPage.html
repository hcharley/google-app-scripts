<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

    <script>
      function onSuccessSearch(contents) {
        hideConfigForm();
        hideLoading();

        var div = document.getElementById('search-results');
        div.style.display = 'block';

        console.log("contents:", contents);
        var items = [];
        contents.map(article => {
          items.push('<li onClick="associateArticle(\'' + article.id + '\')" data-article-id="' + article.id + '">' + article.headline.values[0].value + '</li>');
        })
        console.log("items:", items);
        var list = '<ul>' + items.join('') + '<ul>';
        div.innerHTML = list;
      }

      function onSuccess(contents) {
        hideConfigForm();
        var div = document.getElementById('loading');
        div.style.display = 'block';
        console.log(contents);
        div.innerHTML = '<p style="color: #48C774;">' + contents + "</p>";
      }

      function onFailure(error) {
        var loadingDiv = document.getElementById('loading');
        console.log(error);
        loadingDiv.style.display = "block";
        loadingDiv.innerHTML = "<p class='error'>An error occurred: " + error + "</p>";
      }

      function displayConfigFormMessage(text) {
        var configDiv = document.getElementById('loading');
        configDiv.innerHTML = text;

        hideConfigForm();
        showSearchForm();
      }

      function onSuccessConfigFormValues(data) {
        var accessToken = document.getElementById('access-token');
        accessToken.value = data.accessToken;

        var contentApi = document.getElementById('content-api');
        contentApi.value = data.contentApi;

        var previewUrl = document.getElementById('preview-url');
        previewUrl.value = data.previewUrl;

        var previewSecret = document.getElementById('preview-secret');
        previewSecret.value = data.previewSecret;

        var awsAccessKey = document.getElementById('aws-access-key');
        awsAccessKey.value = data.awsAccessKey;

        var awsSecretKey = document.getElementById('aws-secret-key');
        awsSecretKey.value = data.awsSecretKey;

        var awsBucket = document.getElementById('aws-bucket');
        awsBucket.value = data.awsBucket;
      }

      function getConfigAndDisplayForm() {
        hideSearchForm();
        showConfigForm();
        google.script.run.withFailureHandler(onFailureMeta).withSuccessHandler(onSuccessConfigFormValues).getArticleMeta();
      }

      function showConfigForm() {
        var scriptForm = document.getElementById('script-config-form')
        scriptForm.style.display = "block";
      }

      function hideConfigForm() {
        var scriptForm = document.getElementById('script-config-form')
        scriptForm.style.display = "none";
      }

      function showLoading() {
        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "block";
      }

      function hideLoading() {
        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = "none";
      }

      function showSearchForm() {
        var form = document.getElementById('article-search-form')
        form.style.display = "block";
      }

      function hideSearchForm() {
        var form = document.getElementById('article-search-form')
        form.style.display = "none";
      }

      function onSuccessConfig(data) {
        // hideLoading();
        var loadingDiv = document.getElementById('loading');
        if (data !== null && data !== {} && Object.keys(data).length > 0) {
          loadingDiv.innerHTML = "<div class='success'>Configuration loaded.</div><hr/>"
          hideConfigForm();
          showSearchForm();
        } else {
          showConfigForm();
          loadingDiv.innerHTML = "<div class='error'>No script config found. Fill in the form to use publishing tools.</div><hr/>"
        }
      }

      function onFailureConfig(error) {
        var configDiv = document.getElementById('loading');
        configDiv.innerHTML = "<p class='error'>An error occurred. This may be due to being logged into multiple google accounts at once. Try opening this doc in an incognito window.</p>";
      }

      function handleScriptConfig() {
         google.script.run.withFailureHandler(onFailureConfig).withSuccessHandler(onSuccessConfig).getScriptConfig();
      }

      function handleSearch(formObject) {
        // hideSearchForm();
        hideConfigForm();
        showLoading();

        google.script.run.withSuccessHandler(onSuccessSearch).withFailureHandler(onFailure).handleSearch(formObject);
      }
      
      function associateArticle(articleId) {
        hideLoading();
        console.log("associating article...", articleId);
        // var articleId = $(this).data('article-id');
        // console.log("articleId:", articleId);

        // hideSearchForm();
        hideConfigForm();

        showLoading();
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).associateArticle(articleId);
      }

      window.onload = (function(){
        hideSearchForm();
        hideConfigForm();
        
        handleScriptConfig();
      });

      function handleScriptConfigSubmit(formObject) {
        google.script.run.withSuccessHandler(displayConfigFormMessage).setScriptConfig(formObject);
      }

      // Prevent forms from submitting.
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', preventFormSubmit);


    </script>
    <style>
      .branding-below {
        bottom: 56px;
        top: 0;
      }
      input[type="text"] {
        width: 100%;
      }
      .button, button, input[type="button"] {
        min-width: 0 !important;
      }
      </style>

  </head>
  <body>
    <a id='top' href="#"></a>
    <div id="sidebar-wrapper" class="sidebar branding-below">
      <h1 class="title">Associate this Doc</h1>

      <div class="block gray" id="loading">Loading...</div>

      <div id="script-config-form-output" class="block secondary"></div>
      <form id="script-config-form" onsubmit="handleScriptConfigSubmit(this)">
        <div class="block form-group">
          <label for="access-token">
            <b>Content API Access Token</b>
          </label>
          <input id="access-token" name="ACCESS_TOKEN" type="text" />
        </div>
        <div class="block form-group">
          <label for="content-api">
            <b>Content API URL</b>
          </label>
          <input id="content-api" name="CONTENT_API" type="text" />
        </div>
        <div class="block form-group">
          <label for="preview-url">
            <b>Preview Host URL</b>
          </label>
          <input id="preview-url" name="PREVIEW_URL" type="text" placeholder="http://localhost:3000/api/preview" />
        </div>
        <div class="block form-group">
          <label for="preview-secret">
            <b>Preview Secret Param</b>
          </label>
          <input id="preview-secret" name="PREVIEW_SECRET" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-access-key">
            <b>AWS Access Key ID</b>
          </label>
          <input id="aws-access-key" name="AWS_ACCESS_KEY_ID" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-secret-key">
            <b>AWS Secret Key</b>
          </label>
          <input id="aws-secret-key" name="AWS_SECRET_KEY" type="text" />
        </div>
        <div class="block form-group">
          <label for="aws-bucket">
            <b>AWS Bucket</b>
          </label>
          <input id="aws-bucket" name="AWS_BUCKET" type="text" />
        </div>
        <div class="block form-group">
          <label for="deploy-hook">
            <b>Vercel Deploy Hook</b>
          </label>
          <input id="deploy-hook" name="VERCEL_DEPLOY_HOOK_URL" type="text" />
        </div>
        <div class="block">
          <button class="blue">Save Config</button>
        </div>
      </form>

      <div id="article-search-form">
        <form onsubmit="handleSearch(this)">
          <div class="block form-group">
            <label for="article-headline">
              <b>Search Articles</b>
            </label>
            <input id="article-search" name="article-search" type="text" />
          </div>
          <div class="block">
            <input type="submit" name="search" id="search-button" class="blue" value="Search" />
          </div>
        </form>
      </div>

      <div id="search-results" class="block"></div>

      <div class="block">
        <button onclick="getConfigAndDisplayForm()">Show Config</button>
        <button onclick="hideConfigForm()">Hide Config</button>
      </div>
    </div>

    <div class="sidebar bottom">
      <span class="gray">
        Powered by News Catalyst
      </span>
    </div>

  </body>
</html>


